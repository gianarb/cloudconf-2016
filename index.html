<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Parallel made easy</title>

		<meta name="description" content="Parallel made easy. My CloudConf 2016 talk about ZF3 and the split of our main repository to 50 different repositories">
		<meta name="author" content="Gianluca Arbezzano">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/gianarb_cf.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/github-gist.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h3>A ZF STORY:</h3>
					<h1>Parallel made easy</h1>
					<p>
						<small><a href="http://gianarb.it" target="_blank" >Gianluca Arbezzano</a> / <a target="_blank" href="http://currencyfair.com/">@ CurrencyFair</a></small>
					</p>
				</section>

				<section>
                    <h1>Gianluca Arbezzano</h1>
                    <h2>Software Engineer at CurrencyFair</h2>
				</section>

				<section>
                    <p>
                        <h3>OpenSource maintainer</h3>
                        <span class="fragment" data-fragment-index="1">
                            <img src="img/vim.png" width="200px">
                        </span>
                        <span class="fragment" data-fragment-index="2">
                            <img src="img/influxdb.jpg" width="200px">
                        </span>
                        <span class="fragment" data-fragment-index="3">
                            <img src="img/doctrine.png" width="200px">
                        </span>
                        <span class="fragment" data-fragment-index="4">
                            <img src="img/pennyphp.png" width="200px">
                        </span>
                    </p>
                    <p><a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> - <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a></p>
				</section>

				<section data-background="img/currencyfair.png">
				</section>

				<section>
					<p>Parallel computing is a type of computation in which many
                    calculations are carried out simultaneously, operating
                    on the principle that large problems can often be divided
                    into smaller ones, which are then solved at the same time.
                    <small><a href="https://en.wikipedia.org/wiki/Parallel_computing" target="_blank">by. wikipedia</a></small>
                    </p>
				</section>

				<section>
					<p>
                    <img src="img/serial-processing.jpg"/>
                    <small>Image copyleft Hyde & Rugg, 2014, incorporating house icon from Wikimedia</small>
                    </p>
                     <aside class="notes">
                         you are a builder<br>
                         Red points are your start point and red point
                    </aside>
				</section>

				<section>
					<p>
                    <img src="img/parallel-processing.jpg">
                    <small>Image copyleft Hyde & Rugg, 2014, incorporating house icon from Wikimedia</small>
                    </p>
				</section>

				<section>
					<p>
                    the builder must check to have enough wheelbarrows, trowels and people
                    </p>
				</section>

				<section>
					<p>
                    For us it is <strong>easier</strong> because we have cloud computing.
                    </p>
				</section>

				<section>
                    <p>
                        <backquote>
                            Put another way, a five-person company can harvest 10,000
                            servers with no infrastructure investment, all at the push
                            of a button. That can be pretty disruptive to industries
                            where computing power is everything.
                        </backquote>
                    </p>
                    <p>
                        <small>GreenButton ex. CTO Dave Fellows</small>
                    </p>
				</section>

				<section>
                    <h3>Case Study</h3>
                    <p>
                        We worked to split zendframework/zf2 repository and its
                        history in different and independent repositories
                    </p>
				</section>

				<section>
                    <h3>Why</h3>
                    <ul>
                        <li class="fragment" data-fragment-index="1">maintainability</li>
                        <li class="fragment" data-fragment-index="2">component first</li>
                        <li class="fragment" data-fragment-index="3">Remove old split flow based on git subtree</li>
                    </ul>
				</section>

				<section>
                    <h3>Numbers</h3>
                    <ul>
                        <li class="fragment" data-fragment-index="1">6 years of git's history</li>
                        <li class="fragment" data-fragment-index="2">~27k commits, 67 releases, and over 700 contributors</li>
                        <li class="fragment" data-fragment-index="3"> clean checkout is around 150MB</li>
                    </ul>
                    <p>
                        <small><a href="https://mwop.net/blog/2015-05-15-splitting-components-with-git.html">by mwop's blogpost</a></small>
                    </p>
				</section>

				<section>
                    <h3>Results</h3>
                    <p>50 repositories</p>
                    <p></p>
                    <p><strong>Zend\Http</strong> component repository ended up with ~1.7k
                        commits, 50 releases, ~160 contributors, and a clean checkout clocks in at
                        5.4MB</p>
                    <p>
                        <small><a href="https://mwop.net/blog/2015-05-15-splitting-components-with-git.html">by mwop's blogpost</a></small>
                    </p>
				</section>

				<section>
                    <h3>time</h3>
                    <p>Between 5-12 hours</p>
                    <p class="fragment" data-fragment-index="1">for each repository</p>
                    <p class="fragment" data-fragment-index="2"><img src="img/old-man.jpg"/></p>
				</section>

				<section>
                    <iframe src="//giphy.com/embed/lh4SrOe05v8Fq" width="480" height="254" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
                    <p><a href="http://giphy.com/gifs/lh4SrOe05v8Fq">via GIPHY</a></p>
				</section>

				<section>
                    <p>Obvious! Each component could be split easy in parallel because the process doesn't require nothing. <br>It can leave alone</p>
				</section>

				<section>
                    <p>Made <strong>easy</strong> because after one email AWS allowed our account to power on 55 EC2 instances</p>
                     <aside class="notes">
                        I know are not 10.000 but it is a good start point
                    </aside>
				</section>

				<section>
                    <p>We are worked on two different directions</p>
                    <ul>
                        <li>A procedure to manipulate the git's history</li>
                        <li>A provisioning flow for our servers</li>
                    </ul>
                     <aside class="notes">
                    </aside>
				</section>

				<section>
                    <h1>Provision tools</h1>
                     <aside class="notes">
                         Souspance and start the battle
                    </aside>
				</section>

				<section data-background="./img/il-buono-il-brutto-e-il-cattivo.jpg" >
				</section>

				<section>
                    We have a specific and unique use case.<br>
                    PHP and the AWS sdk could work!!
				</section>

				<section data-background="./img/Frankenstein-Junior1.jpg">
				</section>

				<section>
                    <h2>ZF Parallel Split</h2>
                    <small><a href="https://goo.gl/gRCiub" target="_blank">github.com/gianarb/zf-parallel-split</a></small>
                    <p>This project contains the procedure to boot one server for component and inject the init boot script</p>
				</section>

				<section>
                    <pre><code data-lang="php" style="max-height: 800px;" data-trim data-noescape>
return [
    "aws" => [
        'key' => '',
        'secret' => '',
        'region' => "us-east-1",
    ],
    "githubToken" => "",
    "iam" => [
        "name" =>,
    ],
    "keyName" => "gianarb-def",
    "bucketBackup" => "zend-split",
    "sshPath" => "ssh/",
    "components" => [
        "Authentication",
        "Barcode",
        "Cache",
        "...",
    ]
];
                    </code></pre>
				</section>

				<section>
                    <pre><code data-lang="php" style="max-height: 800px;" data-trim data-noescape>
$result = $client->runInstances(array(
    "ImageId" => "ami-d05e75b8",
    "MinCount" => 1,
    "MaxCount" => 1,
    "InstanceType" => "t2.medium",
    "InstanceInitiatedShutdownBehavior" => "terminate",
    "KeyName" => $config['keyName'],
    "UserData" => base64_encode(render($config, $component)),
    'IamInstanceProfile' => array(
        'Name' => $config['iam']['name'],
    ),
));
                    </code></pre>
                    <p>Launch a <span>t2.medium</span> for each component and create a specific <span>UserData</span> script</p>
				</section>

				<section>
                    <pre><code data-lang="bash" style="max-height: 800px;" data-trim data-noescape>
#!/bin/bash
RAM_DISK=3000m
mount -t tmpfs -o size=$RAM_DISK tmpfs /root
add-apt-repository -y ppa:git-core/ppa
apt-get update
apt-get install -y python2.7 curl git php5 php5-curl php5-cli
git config --global user.name "Gianluca Arbezzano"
git config --global user.email gianarb92@gmail.com
curl "https://bootstrap.pypa.io/get-pip.py" -o "get-pip.py"
python get-pip.py
pip install awscli
aws s3 cp s3://%sshPath%/id_rsa ~/.ssh/id_rsa
chmod 400 ~/.ssh/id_rsa
aws s3 cp s3://%sshPath%/id_rsa.pub ~/.ssh/id_rsa.pub
echo "Host *
     StrictHostKeyChecking no" > ~/.ssh/config
git clone https://github.com/zendframework/component-split.git /root/component-split
cd /root/component-split
./bin/split.sh -c %componentName% -r ./zf2-migrate
cd zf2-migrate
git remote add origin git@github.com:zendframework/zend-%componentName%
git push origin master
git push --tags origin
aws s3 cp /var/log/cloud-init-output.log  s3://%bucketBackup%/zend-%componentName%.log
halt
                    </code></pre>
				</section>

				<section>
                <pre><code data-lang="bash" style="max-height: 800px;" data-trim data-noescape>
#!/bin/bash
RAM_DISK=3000m
mount -t tmpfs -o size=$RAM_DISK tmpfs /root

add-apt-repository -y ppa:git-core/ppa
apt-get update
apt-get install -y python2.7 curl git php5 php5-curl php5-cli
git config --global user.name "Gianluca Arbezzano"
git config --global user.email gianarb92@gmail.com
curl "https://bootstrap.pypa.io/get-pip.py" -o "get-pip.py"
python get-pip.py
                    </code></pre>
                    <p>Work in RAM to increase the performance and prepare the environment</p>
				</section>

				<section>
                    <pre><code data-lang="bash" style="max-height: 800px;" data-trim data-noescape>
pip install awscli
aws s3 cp s3://%sshPath%/id_rsa ~/.ssh/id_rsa
chmod 400 ~/.ssh/id_rsa
aws s3 cp s3://%sshPath%/id_rsa.pub ~/.ssh/id_rsa.pub
                    </code></pre>
                    <p>Install aws cli tool</p>
				</section>

				<section>
                    <pre><code data-lang="bash" style="max-height: 800px;" data-trim data-noescape>
echo "Host *
     StrictHostKeyChecking no" > ~/.ssh/config
git clone https://github.com/zendframework/component-split.git \
    /root/component-split

cd /root/component-split
./bin/split.sh -c %componentName% -r ./zf2-migrate
cd zf2-migrate
git remote add \
    origin git@github.com:zendframework/zend-%componentName%
git push origin master
git push --tags origin
                    </code></pre>
                    <p>Clone the repository with the split procedure, run it and push the new codebase into the component's repository</p>
				</section>

				<section>
                    <pre><code data-lang="bash" style="max-height: 800px;" data-trim data-noescape>
aws s3 cp /var/log/cloud-init-output.log \
    s3://%bucketBackup%/zend-%componentName%.log
halt
                    </code></pre>
                    <p>move the output on s3</p>
				</section>

				<section>
                    <h2>Warning</h2>
                    <img src="img/dbu_tweet.png">

				</section>

				<section data-background="img/liguria.jpg">
				</section>

				<section>
                    <h2>28€</h2>
                    <p data-fragment-index="1" class="fragment">I know, AWS is expensive!</p>
				</section>
				<section>
                    <h2>Thanks</h2>
                    <p>by. @gianarb</p>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

            Reveal.configure({
                keyboard: {
                    38: "prev",
                    40: "next"
                }
            });

		</script>

	</body>
</html>
